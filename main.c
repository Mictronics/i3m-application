#include <string.h>
#include <math.h>
#include "asf.h"
#include "twi-slave/twi-xmega.h"

unsigned char compulab_new [] = {
	0x30, 0xF8, 0xD8, 0x08, 0x08, 0x08, 0x08, 0x0C, 0x0C, 0x2C, 0x44, 0x14, 0x24, 0x06, 0x96, 0xA6,
	0x92, 0xA2, 0x8A, 0xD2, 0x42, 0x42, 0x82, 0x03, 0x03, 0x06, 0x0C, 0x30, 0x40, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x03, 0x0F, 0x3C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x01, 0x07, 0x19, 0x21, 0xC0, 0x00,
	0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF8, 0x1C, 0x0E, 0x06, 0x07, 0x07, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x07, 0x06, 0x06, 0x00, 0x00, 0x00, 0x80, 0xE0, 0x60, 0x30, 0x30, 0x30, 0x30, 0x60, 0xE0, 0x80,
	0x00, 0x00, 0x00, 0xF0, 0xE0, 0xC0, 0x60, 0x30, 0x30, 0x60, 0xE0, 0xC0, 0xC0, 0xE0, 0x60, 0x30,
	0x30, 0x60, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x70, 0x30, 0x30, 0x30, 0x30, 0x60,
	0xE0, 0xC0, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0,
	0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x60, 0x60, 0x30, 0x30, 0x30, 0x30, 0x60, 0x60,
	0xE0, 0x80, 0x00, 0x00, 0xFF, 0xFF, 0xE0, 0x60, 0x30, 0x30, 0x30, 0x60, 0xE0, 0xC0, 0x80, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x03,
	0x0C, 0x08, 0x00, 0x0F, 0x3F, 0x7C, 0xE0, 0xC0, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x80, 0x80, 0x80, 0x00, 0x00, 0x3F, 0x7F, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x7F,
	0x3F, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80,
	0xC1, 0xFF, 0x3F, 0x00, 0x00, 0x7F, 0xFF, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xFF, 0xFF,
	0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xF0, 0xF8, 0x8C, 0x06, 0x06, 0x06, 0x06, 0x8C, 0xCC,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE3, 0x7F, 0x0C,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x1C, 0x38, 0x18, 0x18,
	0x18, 0x0C, 0x0C, 0x0C, 0x06, 0x04, 0x00, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00,
	0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x03, 0x03,
	0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01,
	0x03, 0x03, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00
};

int power;
char powerstring[5];
bool leftButtonStatus,rightButtonStatus,selectButtonStatus;
bool menuEnable;
bool buttonStatus;
bool buttenLastStatus, screen_changed;
long currentPower;

void InitGlobalVars()
{
	power = 999;
	buttenLastStatus = false;
	leftButtonStatus = false;
	rightButtonStatus = false;
	selectButtonStatus = false;
	screen_changed = false;
	menuEnable = true;
}

//***ADC configuration
#define MY_ADC    ADCA
#define MY_ADC_CH ADC_CH0

static void adc_init(void)
{
	struct adc_config adc_conf;
	struct adc_channel_config adcch_conf;


	adc_read_configuration(&MY_ADC, &adc_conf);
	adcch_read_configuration(&MY_ADC, MY_ADC_CH, &adcch_conf);

	adc_set_conversion_parameters(&adc_conf, ADC_SIGN_ON, ADC_RES_12, ADC_REF_VCC);  //signed, 12-bit resolution, VREF = 1V (band gap)
	adc_set_conversion_trigger(&adc_conf, ADC_TRIG_EVENT_SINGLE, 1, 0);
	adc_set_clock_rate(&adc_conf, 100000UL); // 100KHz. Up to 200000UL=200KHz

	adcch_set_input(&adcch_conf, ADCCH_POS_PIN1, ADCCH_NEG_PIN0, 0); // GAIN = 0.5
	adc_write_configuration(&MY_ADC, &adc_conf);
	adcch_write_configuration(&MY_ADC, MY_ADC_CH, &adcch_conf);
}
//***END of ADC Config


void printLogo(struct gfx_mono_bitmap logo){
	gfx_mono_put_bitmap(&logo, 0, 8);
}

void writeText(char* text,int pageAddr,int colAddr){
	ssd1306_set_page_address(pageAddr);
	ssd1306_set_column_address(colAddr);
	ssd1306_write_text(text);
}

float adc_avg(){
	int i;
	long power_avg =0;
	for (i=0;i<5000;i++){
		adc_start_conversion(&MY_ADC, MY_ADC_CH);  //one conversion begins
		LED_On(LED3_GPIO);
//		adc_wait_for_interrupt_flag(&MY_ADC, MY_ADC_CH);
		LED_Off(LED3_GPIO);
		int adca1_result = adc_get_result(&MY_ADC, MY_ADC_CH);
		power_avg=power_avg+adca1_result;
	}

	return power_avg/(i);
}


ISR(TWIC_TWIS_vect)
{
	TWI_interrupt_handler();
}

void enable_interrupts(){
	PMIC.CTRL |= PMIC_MEDLVLEN_bm | PMIC_LOLVLEN_bm;
		sei();
}

void printPower(){
//    int power_result, power_result_old=1000;
    char resString[7];

    currentPower=round(adc_avg()*0.177); //*0.07731r
    if (currentPower < 0)
    	currentPower=0;
	itoa(currentPower, powerstring,10);//power_result
//	if (screen_changed) {  //if just moved to this screen
		ssd1306_clear();
		writeText("Power consumption: ",1,25);
//	}	//else if (power_result==power_result_old) return;
	strcpy(resString,powerstring);
	if (currentPower >0){
		resString[2]=resString[1];
		resString[3]=resString[2];
		resString[1]='.';
		resString[3]=' ';
		resString[4]='W';
		resString[5]='\0';
	} else {
		resString[1]=' ';
		resString[2]='W';
		resString[3]='\0';
	}
	writeText(resString,3,55);

//	power_result_old=power_result;
}

PROGMEM_DECLARE(char const, main_menu_title[]) = "Menu Test Title";
PROGMEM_DECLARE(char const, main_menu_1[]) = "Show Compulab logo";
PROGMEM_DECLARE(char const, main_menu_2[]) = "Do Nothing";
PROGMEM_DECLARE(char const, main_menu_3[]) = "Do Nothing";
PROGMEM_DECLARE(char const, main_menu_4[]) = "Do Nothing";
PROGMEM_DECLARE(char const, main_menu_5[]) = "Do Nothing";
PROGMEM_DECLARE(char const, main_menu_6[]) = "Show voltage";
//@}

PROGMEM_STRING_T main_menu_strings[] = {
	main_menu_1,
	main_menu_2,
	main_menu_3,
	main_menu_4,
	main_menu_5,
	main_menu_6,
};


struct gfx_mono_bitmap compulab_logo = {
	.type = GFX_MONO_BITMAP_RAM,
	.width = 128,
	.height = 32,
	.data.pixmap = compulab_new
};
struct gfx_mono_menu testMenu = {
	.title= main_menu_title,
	.strings = main_menu_strings,
	.num_elements = 6,
	.current_selection = 3
};

int main(void){
    enable_interrupts();

    board_init();
//	sysclk_init();
	gfx_mono_init();
	adc_init();
	pmic_init();
	twi_init();
	
	
	InitGlobalVars();
	

	gfx_mono_menu_init(&testMenu);

	adc_enable(&MY_ADC);

	bool isButtonPressed(bool * lastStatus, uint8_t buttonPos){
		bool currentStatus = ioport_get_value(buttonPos);
		bool result = currentStatus && !(*lastStatus);
		*lastStatus = currentStatus;
		return result;
	}


	bool isLeftButtonPressed(){
		return isButtonPressed(&leftButtonStatus,FP_LEFT_BUTTON);
	}

	bool isRightButtonPressed(){
		return isButtonPressed(&rightButtonStatus,FP_RIGHT_BUTTON);
	}

	bool isSelectButtonPressed(){
		return isButtonPressed(&selectButtonStatus,FP_OK_BUTTON);
	}

	int returnToMenuCount = 0;
	while(true) 
	{
		if (menuEnable){
			if (isLeftButtonPressed())
			{
				gfx_mono_menu_process_key(&testMenu,GFX_MONO_MENU_KEYCODE_UP);
			} else if(isRightButtonPressed()){
				gfx_mono_menu_process_key(&testMenu,GFX_MONO_MENU_KEYCODE_DOWN);
			} else if(isSelectButtonPressed()){
				uint8_t selection = gfx_mono_menu_process_key(&testMenu,GFX_MONO_MENU_KEYCODE_ENTER);
				menuEnable = false;
				if (selection == 0x00){
					ssd1306_clear();
					printLogo(compulab_logo);
				} else if (selection == 0x05){
					ssd1306_clear();
					printPower();
				} else {
					menuEnable = true;
				}
			}
		}else if (isSelectButtonPressed()){
			if (returnToMenuCount == 1){
				returnToMenuCount=0;
				menuEnable = true;
				ssd1306_clear();
				gfx_mono_menu_init(&testMenu);
			}else {
				returnToMenuCount++;
			}
		}
		delay_us(100000); //10ms
	}


	return 0;	
}
