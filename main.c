
#include "ASF/common/boards/board.h"
#include "ASF/common/services/clock/sysclk.h"
#include <string.h>
#include "asf.h"
#include <math.h>
#include "ASF/xmega/boards/stk600/rc064x/stk600_rc064x.h"

unsigned char compulab_new [] = {
	0x30, 0xF8, 0xD8, 0x08, 0x08, 0x08, 0x08, 0x0C, 0x0C, 0x2C, 0x44, 0x14, 0x24, 0x06, 0x96, 0xA6,
	0x92, 0xA2, 0x8A, 0xD2, 0x42, 0x42, 0x82, 0x03, 0x03, 0x06, 0x0C, 0x30, 0x40, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x03, 0x0F, 0x3C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x01, 0x07, 0x19, 0x21, 0xC0, 0x00,
	0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF8, 0x1C, 0x0E, 0x06, 0x07, 0x07, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x07, 0x06, 0x06, 0x00, 0x00, 0x00, 0x80, 0xE0, 0x60, 0x30, 0x30, 0x30, 0x30, 0x60, 0xE0, 0x80,
	0x00, 0x00, 0x00, 0xF0, 0xE0, 0xC0, 0x60, 0x30, 0x30, 0x60, 0xE0, 0xC0, 0xC0, 0xE0, 0x60, 0x30,
	0x30, 0x60, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x70, 0x30, 0x30, 0x30, 0x30, 0x60,
	0xE0, 0xC0, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0,
	0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x60, 0x60, 0x30, 0x30, 0x30, 0x30, 0x60, 0x60,
	0xE0, 0x80, 0x00, 0x00, 0xFF, 0xFF, 0xE0, 0x60, 0x30, 0x30, 0x30, 0x60, 0xE0, 0xC0, 0x80, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x03,
	0x0C, 0x08, 0x00, 0x0F, 0x3F, 0x7C, 0xE0, 0xC0, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x80, 0x80, 0x80, 0x00, 0x00, 0x3F, 0x7F, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x7F,
	0x3F, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80,
	0xC1, 0xFF, 0x3F, 0x00, 0x00, 0x7F, 0xFF, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xFF, 0xFF,
	0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xF0, 0xF8, 0x8C, 0x06, 0x06, 0x06, 0x06, 0x8C, 0xCC,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE3, 0x7F, 0x0C,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x1C, 0x38, 0x18, 0x18,
	0x18, 0x0C, 0x0C, 0x0C, 0x06, 0x04, 0x00, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00,
	0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x03, 0x03,
	0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01,
	0x03, 0x03, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00
};

int power;
char powerstring[5];
bool buttonStatus;
bool buttenLastStatus, screen_changed;

typedef enum {SCREEN_compulab_logo, SCREEN_POWER} SCREEN_TYPE;
SCREEN_TYPE screen;


SCREEN_TYPE changeScreen(SCREEN_TYPE type);


void InitGlobalVars()
{
	power = 999;
	buttenLastStatus = false;
	screen_changed = false;
	screen = SCREEN_compulab_logo;
}

//***ADC configuration
#define MY_ADC    ADCA
#define MY_ADC_CH ADC_CH0

static void adc_init(void)
{

	struct adc_config adc_conf;
	struct adc_channel_config adcch_conf;


	adc_read_configuration(&MY_ADC, &adc_conf);
	adcch_read_configuration(&MY_ADC, MY_ADC_CH, &adcch_conf);

	adc_set_conversion_parameters(&adc_conf, ADC_SIGN_ON, ADC_RES_12, ADC_REF_VCC);  //signed, 12-bit resolution, VREF = 1V (band gap)
	adc_set_conversion_trigger(&adc_conf, ADC_TRIG_EVENT_SINGLE, 1, 0);
	adc_set_clock_rate(&adc_conf, 100000UL); // 100KHz. Up to 200000UL=200KHz

	adcch_set_input(&adcch_conf, ADCCH_POS_PIN1, ADCCH_NEG_PIN0, 0); // GAIN = 0.5
	adc_write_configuration(&MY_ADC, &adc_conf);
	adcch_write_configuration(&MY_ADC, MY_ADC_CH, &adcch_conf);
}
//***END of ADC Config


SCREEN_TYPE changeScreen(SCREEN_TYPE type)
{
	SCREEN_TYPE ret = SCREEN_compulab_logo;
	
	switch(type)
	{
		case SCREEN_compulab_logo:
			ret = SCREEN_POWER;
			break;
		case SCREEN_POWER:
			ret = SCREEN_compulab_logo;
			break;
		default:
			LED_Toggle(LED6_GPIO);
			break;
	}
	return ret;
}

void printLogo(struct gfx_mono_bitmap logo){
	gfx_mono_put_bitmap(&logo, 0, 8);
}

void writeText(char* text,int pageAddr,int colAddr){
	ssd1306_set_page_address(pageAddr);
	ssd1306_set_column_address(colAddr);
	ssd1306_write_text(text);
}

void printPower(){
	int adca1_result;
    int power_result, power_result_old=1000;
    int i;
    char resString[7];
    long power_avg;

	power_avg=0;

	for (i=0;i<1000;i++){
		adc_start_conversion(&MY_ADC, MY_ADC_CH);  //one conversion begins
		LED_On(LED3_GPIO);
//		adc_wait_for_interrupt_flag(&MY_ADC, MY_ADC_CH);
		LED_Off(LED3_GPIO);
		adca1_result = adc_get_result(&MY_ADC, MY_ADC_CH);
		power_avg=power_avg+adca1_result;
	}

	power_avg=power_avg/(i);

	power_result=round(power_avg); //*0.07731r
	itoa(power_result, powerstring,10);//power_result
	if (screen_changed) {  //if just moved to this screen
		ssd1306_clear();
		writeText("Power consumption: ",1,25);
	}	else if (power_result==power_result_old) return;
	strcpy(resString,powerstring);
//	resString[2]=resString[1];
//	resString[3]=resString[2];
//	resString[1]='.';
	resString[3]=' ';
	resString[4]='W';
	resString[5]='\0';
	writeText(resString,3,55);

	power_result_old=power_result;
}
int main(void){

	struct gfx_mono_bitmap compulab_logo;

	board_init();
	sysclk_init();
	gfx_mono_init();
	adc_init();
	pmic_init();
	
	
	InitGlobalVars();
	
	compulab_logo.type = GFX_MONO_BITMAP_RAM;
	compulab_logo.width = 128;
	compulab_logo.height = 32;
	compulab_logo.data.pixmap = compulab_new;


	int count =0;
	adc_enable(&MY_ADC);

	while(true) 
	{
		buttonStatus = ioport_get_value(FP_RIGHT_BUTTON);
		if (buttenLastStatus && !buttonStatus)
		{
			count++;
//			screen = changeScreen(screen);
			screen_changed = true;
		}
		if (screen_changed){
			ssd1306_clear();
			screen_changed = false;
			if (count %2 ==1){
				printLogo(compulab_logo);
			}else {
				printPower();
			}
		}
		buttenLastStatus = buttonStatus;
//		switch(screen)
//		{
//			case SCREEN_compulab_logo :
//				if (screen_changed) {  //if just moved to this screen
//					ssd1306_clear();
//					gfx_mono_put_bitmap(&compulab_logo, 0, 8);
//				}
//				break;
//
//			case SCREEN_POWER :
//				power_avg=0;
//				for (i=0;i<1000;i++){
//					adc_start_conversion(&MY_ADC, MY_ADC_CH);  //one conversion begins
//					LED_On(LED3_GPIO);
//				//	adc_wait_for_interrupt_flag(&MY_ADC, MY_ADC_CH);
//					LED_Off(LED3_GPIO);
//					adca1_result = adc_get_result(&MY_ADC, MY_ADC_CH);
//					power_avg=power_avg+adca1_result;
//				}
//				power_avg=power_avg/(i);
//				power_result=round(power_avg*0.07731);
//				itoa(power_result, powerstring,10);//power_result
//				if (screen_changed) {  //if just moved to this screen
//					ssd1306_clear();
//					ssd1306_set_page_address(1);
//					ssd1306_set_column_address(25);
//					ssd1306_write_text("Power consumption: ");
//				}
//
//				else if (power_result==power_result_old) break;
//				ssd1306_set_page_address(3);
//				ssd1306_set_column_address(55);
//				ssd1306_write_text(powerstring);
//				ssd1306_write_text(" W     ");
//				power_result_old=power_result;
//
//				break;
//
//			default:
//				break;
//		}
//		screen_changed = false;
		delay_us(100000); //10ms
	}


	return 0;	
}
